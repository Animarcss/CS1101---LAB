<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RGB → RGB565 Hex Converter</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;margin:24px}
    .card{max-width:820px;margin:0 auto;padding:18px;border-radius:12px;box-shadow:0 6px 22px rgba(0,0,0,.08)}
    label{display:block;margin-bottom:8px}
    input[type=file]{display:block}
    button{margin-top:12px;padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7}
    pre{white-space:pre-wrap;background:#111;color:#eee;padding:12px;border-radius:8px;overflow:auto;max-height:320px}
    .row{display:flex;gap:12px;align-items:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>Image → RGB565 hex (download as .txt)</h2>
    <p>Upload an image (PNG/JPG). The script converts each pixel to a 16-bit RGB565 value and produces a text file of hex entries (one per line).</p>

    <label>Choose image
      <input id="imgFile" type="file" accept="image/*">
    </label>

    <div class="row">
      <button id="convertBtn" disabled>Convert &amp; Download</button>
      <button id="previewBtn" disabled>Show preview</button>
    </div>

    <p><strong>Preview</strong></p>
    <canvas id="canvas" style="max-width:100%;border:1px solid #ddd;display:none"></canvas>

    <p><strong>Sample output (first 2000 characters)</strong></p>
    <pre id="sample">No output yet.</pre>
  </div>

  <script>
    const fileInput = document.getElementById('imgFile');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const convertBtn = document.getElementById('convertBtn');
    const previewBtn = document.getElementById('previewBtn');
    const sample = document.getElementById('sample');

    let imageLoaded = false;

    fileInput.addEventListener('change', () => {
      if (!fileInput.files || fileInput.files.length === 0) return;
      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
          // resize canvas to image natural size
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          ctx.drawImage(img, 0, 0);
          imageLoaded = true;
          convertBtn.disabled = false;
          previewBtn.disabled = false;
          sample.textContent = 'Ready — click Convert & Download or Show preview.';
        };
        img.onerror = () => {
          sample.textContent = 'Failed to decode image. Try a different image.';
        }
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    previewBtn.addEventListener('click', () => {
      if (!imageLoaded) return;
      canvas.style.display = canvas.style.display === 'none' ? 'block' : 'none';
    });

    // Convert a single pixel (r,g,b) → 16-bit RGB565 value
    function rgbToRgb565(r, g, b) {
      // r: 8-bit, shift to 5 bits; g: 8-bit to 6 bits; b: 8-bit to 5 bits
      const r5 = (r >> 3) & 0x1F;
      const g6 = (g >> 2) & 0x3F;
      const b5 = (b >> 3) & 0x1F;
      return (r5 << 11) | (g6 << 5) | b5; // 0..0xFFFF
    }

    function toHex16(value) {
      return '0x' + value.toString(16).toUpperCase().padStart(4, '0');
    }

    convertBtn.addEventListener('click', () => {
      if (!imageLoaded) return;

      try {
        const w = canvas.width;
        const h = canvas.height;
        // Get raw pixel data (RGBA)
        const imgData = ctx.getImageData(0, 0, w, h).data;
        const lines = [];
        // Loop through pixels (imgData is [r,g,b,a, r,g,b,a, ...])
        for (let i = 0; i < imgData.length; i += 4) {
          const r = imgData[i];
          const g = imgData[i + 1];
          const b = imgData[i + 2];
          const rgb565 = rgbToRgb565(r, g, b);
          lines.push(toHex16(rgb565));
        }

        // Prepare text content: one value per line followed by comma (matching user's python style)
        const text = lines.map(v => v + ',').join('\n');

        // Show a sample preview (first chunk only)
        sample.textContent = text.slice(0, 2000) + (text.length > 2000 ? '\n... (truncated)':'');

        // Create downloadable blob
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const inputName = fileInput.files && fileInput.files[0] ? fileInput.files[0].name.replace(/\.[^/.]+$/, '') : 'image';
        a.href = url;
        a.download = inputName + '_rgb565.txt';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        sample.textContent = 'Error during conversion: ' + err.message;
        console.error(err);
      }
    });
  </script>
</body>
</html>
